# G-code Program Generator Implementation Decisions

This document captures all implementation decisions made for the `gcode_program_generator.py` module.

## 1. Input Data Structure

**Expected input from ProcessingEngine:**
```python
{
    "workpiece": {
        "width": 600.0,              # Original width
        "height": 400.0,             # Original height
        "thickness": 18.0,           # Material thickness
        "width_after_rotation": 400.0,   # Width after rotation (ALWAYS USE THIS)
        "height_after_rotation": 600.0,  # Height after rotation (ALWAYS USE THIS)
    },
    "drill_points": [
        {
            "machine_position": (120.5, 85.3, 0.0),
            "diameter": 8.0,
            "depth": 15.0,
            "extrusion_vector": (0.0, 0.0, 1.0),
            "group_key": (8.0, (0.0, 0.0, 1.0))
        }
    ],
    "grouped_points": {
        (8.0, (0.0, 0.0, 1.0)): [    # Group key: (diameter, extrusion_vector)
            # List of drill points with same tool requirements
        ]
    }
}
```

**Key decisions:**
- Drill points come pre-grouped in `grouped_points` dictionary
- Groups are keyed by `(diameter, extrusion_vector)` tuple
- Trust the data (already validated by upstream pipeline)

## 2. Tool Grouping Strategy

- **Tool Matching**: Call `tool_matcher.match_tool_to_group()` for each group
- **Failure Handling**: If ANY group fails to find a tool â†’ fail entire program
- **Tool Assignment**: Each direction (X+, X-, Y+, Y-) uses a different tool
- **Processing Order**: Process groups as they appear (no sorting for MVP)
- **No partial programs**: Safety first - all or nothing

## 3. G-code Structure

### Machine Settings
- **Spindle Speed**: Default 3000 RPM (for furniture materials, 5-36mm drills)
- **Coolant**: No coolant commands (M08/M09) - not used on this machine
- **Feed Rates**: Use existing settings from MachineSettings

### Program Structure
```
1. Header
   - Attribution comment
   - Date/time stamp
   - Program name
   - Workpiece dimensions (using rotated values)
   - Machine setup (G21, G90, G17, G94)
   - Coordinate system (G55/G56 based on height)
   - M00 operator prompt

2. For each tool group:
   - M05 (spindle off if running)
   - T#M6 (tool change - includes safe height internally)
   - M03 S3000 (spindle on)
   - For each drill point:
     - G00 X Y (position)
     - Drilling sequence from drilling_operations.py

3. Footer
   - M09 (coolant off)
   - M05 (spindle off)
   - T0 (no tool)
   - M30 (program end)
```

### Safety
- Always return to safe Z between points (handled by drilling_operations.py)
- Tool change macro handles safe positioning
- Set all machine states explicitly in header

## 4. Line Numbering

- **Increment**: 5 (N5, N10, N15...)
- **Scope**: Number EVERY line including comments
- **Style**: Continuous throughout program
- **Default**: ON (especially for MVP debugging)

## 5. Error Handling

- **Tool Matching**: Fail immediately on first missing tool
- **Input Validation**: Minimal - trust the pipeline
- **Error Format**: Use standard ErrorHandler pattern
- **Debugging**: Include partial G-code in error details during testing
- **Logging**: Follow module patterns (ERROR for failures, INFO for progress, DEBUG for details)

## 6. Workpiece Measurements

- **Use rotated dimensions**: `width_after_rotation`, `height_after_rotation`
- **Precision**: 1 decimal place (e.g., 400.0mm)
- **Header includes**:
  - `(Generated by DXF to G-code Generator - Anne Ruusmann)`
  - `(Generated on: YYYY-MM-DD HH:MM:SS)`
  - `(Workpiece dimensions: W x H x T mm)`
- **Operator prompt**: `M00 (WORKPIECE WxHxTmm - Confirm in G## position)`

## Implementation Approach

Following ADHD-friendly patterns:

### Helper Functions
1. `_validate_minimal_data()` - Quick sanity check
2. `_add_header_comments()` - Attribution and timestamp
3. `_get_workpiece_dimensions()` - Extract rotated dimensions
4. `_match_tools_to_groups()` - Match all groups, fail on first error
5. `_generate_tool_section()` - Generate code for one tool group
6. `_generate_tool_change()` - T#M6 and spindle commands
7. `_generate_drilling_operations()` - Loop through points
8. `_format_gcode_with_line_numbers()` - Apply line numbering

### Main Flow
1. Minimal validation
2. Generate header with attribution
3. Match tools to all groups
4. For each group: generate tool section
5. Generate footer
6. Apply line numbering
7. Return formatted G-code

## Notes for Implementation

- Keep functions under 30-50 lines
- Use clear section separators
- Log at appropriate levels
- Return standard (success, message, details) tuples
- Include partial G-code in errors for debugging
- Use existing Utils modules (don't reinvent)